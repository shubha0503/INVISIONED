<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InVisionEd - Where Voice Meets Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .dark-mode {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
        }
        
        .light-mode {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            height: 80px;
            flex-shrink: 0;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .content-area {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
            overflow: hidden;
        }
        
        .upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
        }
        
        .chat-section {
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            overflow: hidden;
        }
        
        .voice-button {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 4px solid white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-button:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .voice-button.listening {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        .divider {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-50%);
            z-index: 10;
        }
        
        .dark-mode .divider {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .light-mode .divider {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .file-icon {
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            border-radius: 12px;
            position: relative;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        
        .file-icon:hover {
            transform: scale(1.05);
        }
        
        .file-icon::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .upload-controls {
            width: 100%;
            max-width: 320px;
        }
        
        .file-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .file-input-button {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .file-input-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .file-status {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 0.875rem;
            white-space: nowrap;
            min-width: 120px;
            text-align: center;
        }
        
        .file-info {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #fbbf24;
            color: #000;
            margin-left: auto;
        }
        
        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .system-message {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            text-align: center;
            margin: 0 auto;
        }
        
        .message-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .chat-message:hover .message-controls {
            opacity: 1;
        }
        
        .audio-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .audio-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .audio-button.playing {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.5);
            color: #22c55e;
        }
        
        .chat-actions {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .action-button {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #fbbf24;
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .action-button:hover:not(:disabled) {
            background: #f59e0b;
            transform: translateY(-1px);
        }
        
        .action-button:disabled {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
        }
        
        .question-input-container {
            margin-top: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .question-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: inherit;
            font-size: 0.875rem;
        }
        
        .question-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .question-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }
        
        .theme-toggle {
            width: 60px;
            height: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            padding: 2px;
            position: relative;
        }
        
        .theme-toggle-ball {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
        }
        
        .dark-mode .theme-toggle {
            background: #fbbf24;
        }
        
        .dark-mode .theme-toggle-ball {
            transform: translateX(30px);
        }
        
        .light-mode .theme-toggle {
            background: #6b7280;
        }
        
        .light-mode .theme-toggle-ball {
            transform: translateX(0);
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fbbf24;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .footer {
            height: 40px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #fbbf24;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .content-area {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .divider {
                left: 0;
                right: 0;
                top: 50%;
                bottom: auto;
                width: auto;
                height: 1px;
                transform: translateY(-50%);
            }
            
            .voice-button {
                width: 60px;
                height: 60px;
            }
            
            .upload-section {
                padding: 1rem;
            }
            
            .chat-section {
                padding: 1rem;
            }
            
            .file-icon {
                width: 60px;
                height: 75px;
                margin-bottom: 1rem;
            }
            
            .upload-controls {
                max-width: 280px;
            }
            
            .file-input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .file-status {
                min-width: auto;
            }
            
            .header {
                height: 60px;
                padding: 0 1rem;
            }
            
            .header h1 {
                font-size: 1.125rem;
            }
            
            .header p {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="light-mode">
    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-cyan-500 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold">InVisionEd</h1>
                </div>
            </div>
            
            <div class="flex-1 text-center px-4">
                <p class="text-sm font-medium opacity-80">
                    Where Voice Meets Vision, and Knowledge Knows No Boundaries.
                </p>
            </div>
            
            <!-- Theme Toggle -->
            <div class="theme-toggle" onclick="toggleTheme()">
                <div class="theme-toggle-ball">
                    <svg id="theme-icon" class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Left Panel - File Upload -->
            <div class="upload-section">
                <div class="file-icon">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                    </svg>
                </div>
                
                <h2 class="text-2xl font-semibold mb-6">Upload your File</h2>
                
                <div class="upload-controls">
                    <div>
                        <label class="block text-sm font-medium mb-2">Select File:</label>
                        <div class="file-input-group">
                            <label for="pdf-upload" class="file-input-button">
                                Choose File
                            </label>
                            <div class="file-status">
                                <span id="file-status">No File Chosen</span>
                            </div>
                        </div>
                        <input id="pdf-upload" type="file" class="hidden" accept=".pdf">
                    </div>
                    
                    <div id="file-info" class="file-info hidden">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                        </svg>
                        <span id="file-name"></span>
                    </div>
                </div>
            </div>

            <!-- Voice Button -->
            <div class="voice-button" onclick="toggleVoice()" id="voice-btn">
                <svg id="mic-icon" class="w-8 h-8 text-gray-900" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                </svg>
            </div>

            <!-- Divider -->
            <div class="divider"></div>

            <!-- Right Panel - AI Assistant -->
            <div class="chat-section">
                <div class="chat-header">
                    <h3 class="text-lg font-semibold flex items-center space-x-2">
                        <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span>AI Assistant (Powered by Gemini)</span>
                        <span id="listening-indicator" class="hidden text-xs bg-red-500 text-white px-2 py-1 rounded-full animate-pulse">Listening</span>
                    </h3>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chat-container">
                    <div class="chat-message system-message">
                        <div class="text-sm">Welcome to InVisionEd! I'm powered by Google's Gemini AI and ready to help you analyze documents. Upload a PDF to get started with intelligent document analysis.</div>
                        <div class="text-xs opacity-70 mt-1">System</div>
                        <div class="message-controls">
                            <button class="audio-button" onclick="playMessage(this)">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.816L4.846 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.846l3.537-3.816a1 1 0 011.617.816zM16 8a2 2 0 11-4 0 2 2 0 014 0zm-2 6a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd"/>
                                </svg>
                                Play
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" class="typing-indicator hidden">
                    <span class="text-sm">Gemini AI is analyzing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="chat-actions">
                    <button id="summarize-btn" onclick="handleSummarize()" disabled class="action-button">
                        <span id="summarize-text">Summarise the content</span>
                        <div id="summarize-loader" class="loader hidden"></div>
                    </button>
                    
                    <button id="question-btn" onclick="toggleQuestionMode()" disabled class="action-button">
                        Ask a Question
                    </button>

                    <!-- Question Input (Hidden by default) -->
                    <div id="question-input-container" class="question-input-container hidden">
                        <input id="question-input" type="text" placeholder="Ask a question about the document..." class="question-input">
                        <button onclick="askQuestion()" class="action-button" style="background: #8b5cf6;">
                            Submit Question
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>© 2025 InVisionEd | Designed with inclusion in heart | Powered by Google Gemini AI</p>
        </footer>
    </div>

    <script>
        // Global variables
        let isDarkMode = false;
        let isListening = false;
        let fullText = '';
        let pdfReady = false;
        let recognition = null;
        let currentUtterance = null;
        let isPlaying = false;
        let isPaused = false;

        // Gemini API configuration
        const GEMINI_API_KEY = "AIzaSyDHzrvCf7-hehXV8mRb2CT_DN2ShQ2wPY0";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        // Initialize speech recognition
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                updateVoiceButton();
                document.getElementById('listening-indicator').classList.remove('hidden');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                addChatMessage('user', transcript);
                handleVoiceCommand(transcript);
            };

            recognition.onend = () => {
                isListening = false;
                updateVoiceButton();
                document.getElementById('listening-indicator').classList.add('hidden');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateVoiceButton();
                document.getElementById('listening-indicator').classList.add('hidden');
            };
        }

        // Text-to-Speech Functions
        function playMessage(button) {
            const messageDiv = button.closest('.chat-message');
            const messageText = messageDiv.querySelector('.text-sm').textContent;
            
            if (currentUtterance && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            currentUtterance = new SpeechSynthesisUtterance(messageText);
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;
            
            currentUtterance.onstart = () => {
                isPlaying = true;
                isPaused = false;
                button.classList.add('playing');
                button.innerHTML = `
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    Playing
                `;
            };
            
            currentUtterance.onend = () => {
                isPlaying = false;
                isPaused = false;
                button.classList.remove('playing');
                button.innerHTML = `
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.816L4.846 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.846l3.537-3.816a1 1 0 011.617.816zM16 8a2 2 0 11-4 0 2 2 0 014 0zm-2 6a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd"/>
                    </svg>
                    Play
                `;
            };
            
            speechSynthesis.speak(currentUtterance);
        }

        // Auto-play AI responses
        function playAIResponse(text) {
            if (currentUtterance && speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;
            
            speechSynthesis.speak(currentUtterance);
        }

        // Theme toggle
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (isDarkMode) {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeIcon.innerHTML = '<path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>';
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeIcon.innerHTML = '<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>';
            }
        }

        // Voice button toggle
        function toggleVoice() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser.');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function updateVoiceButton() {
            const voiceBtn = document.getElementById('voice-btn');
            const micIcon = document.getElementById('mic-icon');
            
            if (isListening) {
                voiceBtn.classList.add('listening');
                micIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zm1 3a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>';
            } else {
                voiceBtn.classList.remove('listening');
                micIcon.innerHTML = '<path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>';
            }
        }

        // File upload handling
        document.getElementById('pdf-upload').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                alert('Please select a valid PDF file.');
                return;
            }

            document.getElementById('file-status').textContent = 'Processing...';
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-info').classList.remove('hidden');

            try {
                const fileReader = new FileReader();
                fileReader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                    let extractedText = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        extractedText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    
                    fullText = extractedText;
                    pdfReady = true;
                    
                    document.getElementById('file-status').textContent = 'Ready';
                    
                    // Enable buttons
                    document.getElementById('summarize-btn').disabled = false;
                    document.getElementById('question-btn').disabled = false;
                    
                    const successMessage = `PDF "${file.name}" uploaded successfully! I've analyzed ${Math.round(extractedText.length / 1000)}k characters. You can now ask questions or request a summary.`;
                    addChatMessage('system', successMessage);
                    
                    // Auto-play success message
                    setTimeout(() => {
                        playAIResponse(successMessage);
                    }, 500);
                };
                fileReader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error processing PDF:', error);
                document.getElementById('file-status').textContent = 'Error';
                alert('Failed to process PDF. Please try again.');
            }
        });

        // Chat functions
        function addChatMessage(type, message) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let messageClass = 'chat-message ';
            if (type === 'user') messageClass += 'user-message';
            else if (type === 'system') messageClass += 'system-message';
            else messageClass += 'ai-message';
            
            messageDiv.className = messageClass;
            
            let messageHTML = `
                <div class="text-sm leading-relaxed">${message}</div>
                <div class="text-xs opacity-70 mt-1">${timestamp}</div>
            `;
            
            // Add play button for AI and system messages
            if (type === 'ai' || type === 'system') {
                messageHTML += `
                    <div class="message-controls">
                        <button class="audio-button" onclick="playMessage(this)">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.816L4.846 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.846l3.537-3.816a1 1 0 011.617.816zM16 8a2 2 0 11-4 0 2 2 0 014 0zm-2 6a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd"/>
                            </svg>
                            Play
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = messageHTML;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typing-indicator').classList.remove('hidden');
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator').classList.add('hidden');
        }

        // Real Gemini AI API call
        async function callGeminiAI(prompt) {
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('No valid content received from Gemini AI.');
                }
            } catch (error) {
                console.error('Gemini AI Error:', error);
                throw error;
            }
        }

        // Summarize function
        async function handleSummarize() {
            if (!fullText) {
                alert('Please upload a PDF first.');
                return;
            }

            const summarizeBtn = document.getElementById('summarize-btn');
            const summarizeText = document.getElementById('summarize-text');
            const summarizeLoader = document.getElementById('summarize-loader');
            
            summarizeBtn.disabled = true;
            summarizeText.textContent = 'Generating summary...';
            summarizeLoader.classList.remove('hidden');
            
            showTypingIndicator();

            try {
                const prompt = `Please provide a comprehensive and well-structured summary of the following document. Focus on the main points, key concepts, important details, and any conclusions. Make the summary clear and easy to understand:

Document Content:
${fullText.substring(0, 30000)}

Please provide a detailed summary that captures the essence of this document.`;

                const summary = await callGeminiAI(prompt);
                
                hideTypingIndicator();
                addChatMessage('ai', summary);
                
                // Auto-play the summary
                setTimeout(() => {
                    playAIResponse(summary);
                }, 500);
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                const errorMessage = `Sorry, I encountered an error while generating the summary: ${error.message}. Please try again.`;
                addChatMessage('ai', errorMessage);
                playAIResponse(errorMessage);
            } finally {
                summarizeBtn.disabled = false;
                summarizeText.textContent = 'Summarise the content';
                summarizeLoader.classList.add('hidden');
            }
        }

        // Question handling
        function toggleQuestionMode() {
            const questionContainer = document.getElementById('question-input-container');
            questionContainer.classList.toggle('hidden');
            if (!questionContainer.classList.contains('hidden')) {
                document.getElementById('question-input').focus();
            }
        }

        async function askQuestion() {
            const questionInput = document.getElementById('question-input');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('Please enter a question.');
                return;
            }

            if (!fullText) {
                alert('Please upload a PDF first.');
                return;
            }

            addChatMessage('user', question);
            questionInput.value = '';
            
            showTypingIndicator();

            try {
                const prompt = `Based on the following document, please answer this question accurately and comprehensively: "${question}"

Document Content:
${fullText.substring(0, 30000)}

Please provide a detailed answer based on the information in the document. If the answer is not directly available in the document, please mention that and provide any relevant context that might be helpful.`;

                const answer = await callGeminiAI(prompt);
                
                hideTypingIndicator();
                addChatMessage('ai', answer);
                
                // Auto-play the answer
                setTimeout(() => {
                    playAIResponse(answer);
                }, 500);
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                const errorMessage = `Sorry, I encountered an error while processing your question: ${error.message}. Please try again.`;
                addChatMessage('ai', errorMessage);
                playAIResponse(errorMessage);
            }
        }

        // Voice command handling
        function handleVoiceCommand(transcript) {
            const command = transcript.toLowerCase();
            
            if (command.includes('summarize') || command.includes('summary')) {
                handleSummarize();
            } else if (command.includes('question')) {
                toggleQuestionMode();
            } else {
                // Treat as a question
                if (fullText) {
                    showTypingIndicator();
                    const prompt = `Based on the following document, please answer this question: "${transcript}"

Document Content:
${fullText.substring(0, 30000)}

Please provide a clear and helpful answer based on the document content.`;

                    callGeminiAI(prompt)
                        .then(answer => {
                            hideTypingIndicator();
                            addChatMessage('ai', answer);
                            setTimeout(() => {
                                playAIResponse(answer);
                            }, 500);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            hideTypingIndicator();
                            const errorMessage = `Sorry, I encountered an error: ${error.message}. Please try again.`;
                            addChatMessage('ai', errorMessage);
                            playAIResponse(errorMessage);
                        });
                } else {
                    const message = 'Please upload a PDF first before asking questions.';
                    addChatMessage('ai', message);
                    playAIResponse(message);
                }
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Spacebar to activate voice (when not typing in input)
            if (event.code === 'Space' && event.target.tagName !== 'INPUT') {
                event.preventDefault();
                toggleVoice();
            }
            
            // Enter to send question
            if (event.code === 'Enter' && event.target.id === 'question-input') {
                askQuestion();
            }
        });

        // Initialize welcome message
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const welcomeMessage = "Hello! I'm your AI assistant powered by Google's Gemini. Upload a PDF document and I'll help you understand, summarize, and answer questions about it using advanced AI analysis.";
                playAIResponse(welcomeMessage);
            }, 1000);
        });
    </script>
</body>
</html>